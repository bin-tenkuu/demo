<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ç®¡ç†å™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .path-display {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            word-break: break-all;
        }
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .file-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            vertical-align: middle;
        }
        .folder-link, .file-link {
            color: #007bff;
            text-decoration: none;
        }
        .folder-link:hover, .file-link:hover {
            text-decoration: underline;
        }
        .size-cell {
            text-align: right;
        }
        .type-cell {
            color: #6c757d;
        }
        .nav-buttons {
            margin-bottom: 15px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        .error {
            color: #dc3545;
            padding: 10px;
            background-color: #f8d7da;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ–‡ä»¶ç®¡ç†å™¨</h1>

        <div class="path-display">
            å½“å‰è·¯å¾„: <span id="currentPath">/</span>
        </div>

        <div class="nav-buttons">
            <button class="btn" onclick="goBack()">è¿”å›ä¸Šçº§ç›®å½•</button>
            <button class="btn btn-success" onclick="refreshCurrentPath()">åˆ·æ–°å½“å‰è·¯å¾„</button>
        </div>

        <div class="upload-form">
            <h3>ä¸Šä¼ æ–‡ä»¶</h3>
            <input type="file" id="fileInput" multiple>
            <button class="btn btn-success" onclick="uploadFile()">ä¸Šä¼ </button>
        </div>

        <div id="errorMessage"></div>

        <div id="fileTable">
            <table>
                <thead>
                    <tr>
                        <th>åç§°</th>
                        <th>ç±»å‹</th>
                        <th>å¤§å°</th>
                    </tr>
                </thead>
                <tbody id="fileList">
                    <!-- æ–‡ä»¶åˆ—è¡¨å°†é€šè¿‡JavaScriptå¡«å…… -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // APIåŸºç¡€URL - è¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
        const API_BASE_URL = '/file'; // å‡è®¾APIåœ¨åŒåŸŸä¸‹

        // å½“å‰è·¯å¾„
        let currentPath = "/";

        // è·å–æ–‡ä»¶åˆ—è¡¨
        async function listFiles(path) {
            showLoading(true);
            const response = await fetch(`${API_BASE_URL}/list?path=${encodeURIComponent(path)}`);

            if (response.ok) {
                const files = await response.json();
                displayFiles(files);
            } else {
                showError(`è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: HTTP ${response.status}`);
                console.error('Error fetching files:', response.status);
                displayFiles([]);
            }
            showLoading(false);
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(show) {
            const fileListElement = document.getElementById('fileList');
            if (show) {
                fileListElement.innerHTML = '<tr><td colspan="3" class="loading">åŠ è½½ä¸­...</td></tr>';
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                errorDiv.innerHTML = '';
            }, 5000); // 5ç§’åè‡ªåŠ¨æ¸…é™¤é”™è¯¯æ¶ˆæ¯
        }

        // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
        function displayFiles(files) {
            const fileListElement = document.getElementById('fileList');
            fileListElement.innerHTML = '';

            if (files.length === 0) {
                fileListElement.innerHTML = '<tr><td colspan="3" class="loading">æ­¤ç›®å½•ä¸ºç©º</td></tr>';
                return;
            }

            files.forEach(file => {
                const row = document.createElement('tr');

                let nameCell = '';
                if (file.dir) {
                    nameCell = `<a href="#" class="folder-link" onclick="openDirectory('${file.name}')">${getFileIcon('directory')} ${file.name}</a>`;
                } else {
                    nameCell = `<a href="#" class="file-link" onclick="downloadFile('${file.name}')">${getFileIcon('file')} ${file.name}</a>`;
                }

                const sizeCell = formatFileSize(file.size);

                row.innerHTML = `
                    <td>${nameCell}</td>
                    <td class="type-cell">${file.dir ? 'ç›®å½•' : 'æ–‡ä»¶'}</td>
                    <td class="size-cell">${sizeCell}</td>
                `;

                fileListElement.appendChild(row);
            });
        }

        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(type) {
            if (type === 'directory') {
                return '<span role="img" aria-label="folder">ğŸ“</span>';
            } else {
                return '<span role="img" aria-label="file">ğŸ“„</span>';
            }
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ‰“å¼€ç›®å½•
        async function openDirectory(dirName) {
            if (currentPath === '/') {
                currentPath = '/' + dirName;
            } else {
                currentPath += '/' + dirName;
            }
            await updateDisplay();
        }

        // è¿”å›ä¸Šçº§ç›®å½•
        async function goBack() {
            if (currentPath === '/') return;

            const pathParts = currentPath.split('/');
            pathParts.pop(); // ç§»é™¤æœ€åä¸€ä¸ªç©ºå…ƒç´ æˆ–ç›®å½•å

            if (pathParts.length === 1) {
                currentPath = '/';
            } else {
                currentPath = pathParts.join('/');
            }

            await updateDisplay();
        }

        // åˆ·æ–°å½“å‰è·¯å¾„
        async function refreshCurrentPath() {
            await updateDisplay();
        }

        // æ›´æ–°æ˜¾ç¤º
        async function updateDisplay() {
            document.getElementById('currentPath').textContent = currentPath;
            await listFiles(currentPath);
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(fileName) {
            const relativePath = currentPath === '/' ? fileName : currentPath + '/' + fileName;
            const downloadUrl = `${API_BASE_URL}/download?path=${encodeURIComponent(relativePath)}`;

            // åˆ›å»ºéšè—é“¾æ¥å¹¶è§¦å‘ä¸‹è½½
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;

            if (files.length === 0) {
                showError('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
                return;
            }

            // è®°å½•æ–‡ä»¶æ•°é‡ç”¨äºæç¤º
            const fileCount = files.length;

            // ç›´æ¥ä½¿ç”¨å½“å‰è·¯å¾„
            const uploadPath = currentPath;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                const formData = new FormData();
                formData.append('path', uploadPath);
                formData.append('file', file);

                const response = await fetch(`${API_BASE_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.text();
                    console.log(`æ–‡ä»¶ ${file.name} ä¸Šä¼ æˆåŠŸï¼Œä¿å­˜è·¯å¾„: ${result}`);
                } else {
                    const errorText = await response.text();
                    showError(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥: HTTP ${response.status} - ${errorText}`);
                    console.error('Upload error:', response.status, errorText);
                }
            }

            // æ¸…ç©ºè¡¨å•
            fileInput.value = '';

            // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
            await updateDisplay();
            showLoading(false);
            alert(`æˆåŠŸä¸Šä¼  ${fileCount} ä¸ªæ–‡ä»¶`);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await updateDisplay();
        });
    </script>
</body>
</html>
